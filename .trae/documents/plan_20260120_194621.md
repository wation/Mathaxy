## 实现计划

### 1. 分析问题
- 当前关卡解锁逻辑是：完成前一关解锁下一关
- 第1关总是解锁，其他关卡需要前一关完成才能解锁
- 游戏完成后应该调用 `saveGameResult()` 方法更新用户资料
- 问题可能出在游戏完成时没有正确调用保存游戏结果的方法

### 2. 实现方案
1. **检查 `completeGame()` 方法调用**：确保游戏完成时正确调用 `saveGameResult()`
2. **验证 `gameSession` 状态**：确保 `isCompleted` 和 `isFailed` 状态正确设置
3. **检查 `saveGameResult()` 实现**：确保用户资料更新逻辑正确
4. **添加调试日志**：帮助追踪问题

### 3. 代码修改
1. **修改 `GamePlayViewModel.swift`**：
   - 确保 `completeGame()` 方法被正确调用
   - 验证 `gameSession.isCompleted` 和 `gameSession.isFailed` 的设置
   - 确保 `userProfile.completeLevel(gameSession.level)` 被正确调用

2. **修改 `GameViewModel.swift`**：
   - 确保 `saveGameResults()` 方法中的 `isCompleted` 判断正确
   - 验证 `userProfile.completeLevel(gameSession.level)` 被正确调用

3. **添加调试日志**：
   - 在 `saveGameResult()` 和 `saveGameResults()` 方法中添加日志
   - 记录关卡完成状态和用户资料更新情况

### 4. 预期效果
- 完成第8关后，第9关将被解锁
- 完成第9关后，第10关将被解锁
- 关卡选择界面会实时刷新，显示解锁状态
- 用户资料中的 `completedLevels` 集合会正确更新

### 5. 测试验证
1. 运行游戏，进入第8关
2. 完成第8关，检查是否解锁第9关
3. 进入第9关，完成后检查是否解锁第10关
4. 验证关卡选择界面的解锁状态是否正确
5. 检查用户资料中的 `completedLevels` 是否包含完成的关卡

### 6. 技术要点
- 确保游戏完成时正确调用保存游戏结果的方法
- 验证 `gameSession` 状态设置正确
- 确保用户资料更新逻辑正确
- 利用 `NotificationCenter` 实现UI实时刷新
- 添加调试日志便于问题追踪